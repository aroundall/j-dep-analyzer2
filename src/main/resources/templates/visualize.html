<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{base}">

<head>
    <title th:text="${title}">Visualize - J-Dep Analyzer</title>
</head>

<body>
    <div layout:fragment="content">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">

            <!-- Left Sidebar: Info Card -->
            <div class="lg:col-span-1">
                <div class="bg-surface rounded-xl shadow-mate-1 border border-gray-100 p-6 sticky top-24">
                    <div class="flex items-center gap-2 mb-4">
                        <span class="material-symbols-outlined text-primary-600">info</span>
                        <h3 class="font-semibold text-gray-900">Artifact Details</h3>
                    </div>

                    <dl class="space-y-3">
                        <div>
                            <dt class="text-xs font-medium text-gray-500 uppercase">Group ID</dt>
                            <dd class="font-mono text-sm text-gray-900 break-all" th:text="${groupId}">com.example</dd>
                        </div>
                        <div>
                            <dt class="text-xs font-medium text-gray-500 uppercase">Artifact ID</dt>
                            <dd class="font-mono text-sm text-gray-900 break-all" th:text="${artifactId}">my-app</dd>
                        </div>
                        <div>
                            <dt class="text-xs font-medium text-gray-500 uppercase">Version</dt>
                            <dd class="font-mono text-sm text-gray-900" th:text="${version}">1.0.0</dd>
                        </div>
                    </dl>

                    <hr class="my-4 border-gray-200">

                    <a th:href="@{/dependencies/list(q=${artifactId})}"
                        class="text-sm text-primary-600 hover:text-primary-700 flex items-center gap-1">
                        <span class="material-symbols-outlined text-sm">arrow_back</span>
                        View in Dependencies List
                    </a>
                </div>
            </div>

            <!-- Right: Graph Card -->
            <div class="lg:col-span-3">
                <div
                    class="bg-surface rounded-xl shadow-mate-1 border border-gray-100 flex flex-col overflow-hidden h-[700px]">
                    <div class="px-6 py-4 border-b border-gray-100 bg-gray-50 flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary-600">hub</span>
                            <h3 class="font-semibold text-gray-900">Dependency Graph</h3>
                        </div>

                        <!-- Graph Controls -->
                        <div class="flex items-center gap-4 text-sm">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="toggle-group"
                                    class="rounded border-gray-300 text-primary-600 focus:ring-primary-500" checked
                                    onchange="refreshGraph()">
                                <span class="text-gray-600">Combine Groups</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="toggle-version"
                                    class="rounded border-gray-300 text-primary-600 focus:ring-primary-500" checked
                                    onchange="refreshGraph()">
                                <span class="text-gray-600">Combine Versions</span>
                            </label>

                            <div class="h-4 w-px bg-gray-300 mx-2"></div>

                            <select id="direction-select" onchange="refreshGraph()"
                                class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 p-1.5">
                                <option value="forward">Forward</option>
                                <option value="reverse">Reverse (Who uses this?)</option>
                            </select>

                            <select id="depth-select" onchange="refreshGraph()"
                                class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 p-1.5">
                                <option value="">All</option>
                                <option value="1">1 Level</option>
                                <option value="2" selected>2 Levels</option>
                                <option value="3">3 Levels</option>
                            </select>

                            <select id="layout-select" onchange="updateLayout()"
                                class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 p-1.5">
                                <option value="dagre" selected>Hierarchy (Dagre)</option>
                                <option value="cose">Force (Cose)</option>
                                <option value="grid">Grid</option>
                                <option value="circle">Circle</option>
                                <option value="concentric">Concentric</option>
                                <option value="breadthfirst">Breadthfirst</option>
                            </select>

                            <button onclick="cy.fit()" class="text-gray-500 hover:text-primary-600"
                                title="Fit to Screen">
                                <span class="material-symbols-outlined">fit_screen</span>
                            </button>
                        </div>
                    </div>

                    <div id="cy" class="flex-grow w-full h-full bg-white relative"></div>
                </div>
            </div>
        </div>

        <script th:inline="javascript">
            var cy;
            var rootId = [[${ rootId }]];

            document.addEventListener('DOMContentLoaded', function () {
                refreshGraph();
            });

            function refreshGraph() {
                const showGroup = !document.getElementById('toggle-group').checked;
                const showVersion = !document.getElementById('toggle-version').checked;
                const direction = document.getElementById('direction-select').value;
                const depth = document.getElementById('depth-select').value;

                let url = `/api/graph/data?root_id=${encodeURIComponent(rootId)}&show_group=${showGroup}&show_version=${showVersion}&direction=${direction}`;
                if (depth) {
                    url += `&depth=${depth}`;
                }

                fetch(url)
                    .then(res => res.json())
                    .then(data => {
                        const el = document.getElementById('cy');
                        if (!data.elements || data.elements.length === 0) {
                            el.innerHTML = '<div class="flex h-full items-center justify-center text-gray-400">No dependency data found.</div>';
                            if (cy) cy.destroy();
                            cy = null;
                        } else {
                            el.innerHTML = '';
                            initCy(data.elements);
                        }
                    })
                    .catch(err => {
                        console.error("Failed to load graph:", err);
                    });
            }

            function initCy(elements) {
                if (cy) cy.destroy();

                cy = cytoscape({
                    container: document.getElementById('cy'),
                    elements: elements,
                    minZoom: 0.1,
                    maxZoom: 3,
                    wheelSensitivity: 0.3,
                    style: [
                        {
                            selector: 'node',
                            style: {
                                'background-color': '#6366f1',
                                'label': 'data(label)',
                                'color': '#1e293b',
                                'font-size': '12px',
                                'font-family': 'Inter, sans-serif',
                                'text-valign': 'center',
                                'text-halign': 'center',
                                'width': 'label',
                                'height': 'label',
                                'padding': '12px',
                                'shape': 'round-rectangle',
                                'text-wrap': 'wrap',
                                'text-max-width': '120px',
                                'border-width': 1,
                                'border-color': '#e0e7ff',
                                'background-opacity': 0.1
                            }
                        },
                        {
                            selector: 'node.root',
                            style: {
                                'background-color': '#dc2626',
                                'background-opacity': 0.2,
                                'border-color': '#dc2626',
                                'border-width': 2,
                                'font-weight': 'bold'
                            }
                        },
                        {
                            selector: 'node.highlight',
                            style: {
                                'background-color': '#f59e0b',
                                'background-opacity': 0.2,
                                'border-color': '#f59e0b'
                            }
                        },
                        {
                            selector: 'edge',
                            style: {
                                'width': 1,
                                'line-color': '#cbd5e1',
                                'target-arrow-color': '#cbd5e1',
                                'target-arrow-shape': 'triangle',
                                'curve-style': 'bezier'
                            }
                        },
                        {
                            selector: ':selected',
                            style: {
                                'background-color': '#4f46e5',
                                'line-color': '#4f46e5',
                                'target-arrow-color': '#4f46e5',
                                'source-arrow-color': '#4f46e5',
                                'color': '#4f46e5',
                                'font-weight': 'bold',
                                'border-color': '#4f46e5',
                                'border-width': 2
                            }
                        }
                    ],
                    layout: {
                        name: document.getElementById('layout-select').value,
                        rankDir: 'LR',
                        padding: 50,
                        animate: true,
                        stop: function () {
                            cy.fit(undefined, 50);
                        }
                    }
                });

                cy.on('tap', 'node', function (evt) {
                    var node = evt.target;
                    const id = node.id();
                    if (id && id !== rootId) {
                        window.location.href = `/visualize/${encodeURIComponent(id)}`;
                    }
                });
            }

            function updateLayout() {
                if (!cy) return;
                const layoutName = document.getElementById('layout-select').value;
                const layoutConfig = {
                    name: layoutName,
                    animate: true,
                    animationDuration: 500,
                    padding: 50
                };

                if (layoutName === 'dagre') {
                    layoutConfig.rankDir = 'LR';
                }

                cy.layout(layoutConfig).run();
            }
        </script>
    </div>
</body>

</html>